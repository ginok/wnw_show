// jQueryに naturalWidth() と naturalHeight()を追加する
(function($){
    var props = ['Width', 'Height'],prop;
    while (prop = props.pop()) {
       (function (natural, prop) {
           $.fn[natural] = (natural in new Image()) ?
               function () {return this[0][natural];} :
           function () {
               var node = this[0],img,value;
              if (node.tagName.toLowerCase() === 'img') {
                  img = new Image();
                img.src = node.src,value = img[prop];
              }
              return value;
          };
       }('natural' + prop, prop.toLowerCase()));
   }
}(jQuery));

var wnw;
if (!wnw) wnw = {};
if (!wnw.list) wnw.list = {};
(function(){
    var assetPath = function(name) {
        // for wnw rails environment
        return "<%= asset_path('wnw_show/list/" + name + "') %>";
        // for local test
        //return "/wnw_show/vendor/assets/images/wnw_show/list/" + name;
    };

    // -------------------------------------
    // 定数
    // -------------------------------------
    var LEFT_MARGIN = 50; //左のマージン
    var TOP_MARGIN =  50; //上のマージン
    var BACKGROUND_IMAGE = '';//背景画像
    //画像
    var MSG_RATIO = 0.6; //画像の拡大サイズ
    var MSG_Y_SPAN = 250; //写真の縦の間隔
    var MSG_X_SPAN = 250; //写真の縦の間隔
    var MSG_WIDTH  = 250; //写真の横幅
    var MSG_ROW_NO = 4; //写真の列数
    //画像追加
    var ADD_IMAGE_RANGE_X = 1000;//画像が追加されるときのX座標の範囲
    var ADD_IMAGE_RANGE_Y = 0;//画像が追加されるときのY座標の範囲
    //ズーム
    var ZOOM_Z_INDEX = 1001;
    var ZOOM_TIME = 500;
    //画像前後ボタン
    var Z_INDEX_NEXT_PREV = 1002;
    var NEXT_BUTTON_ID = "nextButton";
    var PREV_BUTTON_ID = "prevButton";

    // -------------------------------------
    // 変数
    // -------------------------------------
    var gZIndexMax = 2;//現在画面で表示されている中で最大のz-Index
    var gImgUrlList; //画像URLのリスト
    var gLargeImgUrlList; //画像URLのリスト
    var gImgList = [];//画像のjqueryオブジェクトのリスト
    var gLargeImgList = [];//画像のjqueryオブジェクトのリスト
    var gZoomImgId = -1;//現在zoom中の画像のID
    var gContextPath;//このスクリプトが呼ばれるURLコンテキストパス

    // -------------------------------------
    // 関数
    // -------------------------------------

    // 画像を表示する
    //
    // @param
    //   no :
    //   url: 画像のURL
    //   large_url: 画像のURL
    //   top: 画像のtop
    //   left: 画像のleft
    //   zIndex: 画像のz-index
    //   orgtop: 画像の整列後のtop
    //   orgleft: 画像の整列後のleft
    //   callback: 画像がロードされたら呼び出す関数
    function viewImage(no,url,large_url,top,left,zIndex,callback){
        $("#bord").append(large_img);
        gLargeImgList.push(large_img);

        //サムネイル画像
        var cheki = $("<div />")
            .addClass("cheki")
            .attr("id","img"+no)
            .attr("large_id","large_img"+no)
            .attr("no", no)
            .attr("next", no+1)
            .attr("prev", no-1)
            .attr("msg_id",url)
            .css({"top":top,
                  "left":left,
                  "z-index":zIndex,
                  "opacity":0
                 })
            .click(function(){
                // Zoom
                if(gZoomImgId == -1 ){
                    //Zoomしていない時はZoom
                    zoom($(this).attr("large_id"));
                }else{
                    //Zoom中は元の位置に戻す
                    unzoom(gZoomImgId);
                    $("#" + NEXT_BUTTON_ID).hide();
                    $("#" + PREV_BUTTON_ID).hide();
                };
            })
            .load(function(){
                //画像の大きさを比率で指定する場合以下をコメントアウト
                //$(this).width($(this).naturalWidth() * MSG_RATIO);
                //$(this).height($(this).naturalHeight() * MSG_RATIO);
                $(this).css({"opacity":1});
                //callback
                callback();
            })
            .append($("<img/>").attr("src",url))
        ;
        $("#bord").append(cheki);
//        gImgList.push(img);

    };

    // 画像のズームを解除する
    // @param
    //   id : 画像のID
    function unzoom(id){
        if(gZoomImgId != -1){
            console.log("unzoom" + id);
            gZoomImgId = -1;
            var _img=$("#" + id).hide();
            $("#maku").hide();
        }
    }

    //画像を追加する
    // @param
    //   url : 画像のurl
    function addImage(url,large_url){
        //整列後の位置を先に計算
        gImgUrlList.push(url);
        var no = gImgList.length;
        var orgtop = TOP_MARGIN + Math.floor(no / MSG_ROW_NO ) * MSG_Y_SPAN;
        if(no % MSG_ROW_NO == 0){ //１列目
            var orgleft = LEFT_MARGIN;
        }else{
            leftside = gImgList[no - 1];
            var orgleft = leftside.offset().left + leftside.width();
        }
        //実際に表示するのはランダムな位置
        gZIndexMax += 1;
        viewImage(gImgList.length,url, large_url,ADD_IMAGE_RANGE_Y,ADD_IMAGE_RANGE_X,gZIndexMax,function(){});
    };


    // -------------------------------------
    // メイン処理
    // -------------------------------------
    function display(msgList){
        //make_list(msgList);
        make_slide(msgList);
    };
    function make_list(msgList){
        //背景
        $("body").append($("<div/>").attr("id","bord"));
        // 写真
        for(i = 0 ; i < msgList.length; i = i + 1){
            var msg = msgList[i];
            //写真
            var _img = $("<img/>")
                .attr("src",msg["small"])
                .hide()
                .load(function(){
                    if($(this).naturalWidth() > $(this).naturalHeight()){
                        //横長であれば、写真のセンターが真ん中に来るようにずらす
                        var _left =  - ( $(this).naturalWidth() - $(this).naturalHeight() ) / 2;
                        $(this).css({"position":"absolute","height":"100%","left" : _left});
                    }else{
                        //縦長であれば、ずらさない。写真の上を枠の上に重ねる配置。
                        var _top = 0;
                        $(this).css({"position":"absolute","width":"100%","top" : _top});
                    }
                    $(this).show();
                })
            ;
            //チェキ
            var _cheki = $("<div />")
                .addClass("cheki")
                .attr("id","img"+ i)
                .attr("large_id","large_img"+i)
                .attr("no", i)
                .attr("next", i+1)
                .attr("prev", i-1)
                .css({
                    left : i * 200
                })
                .append($("<figure/>").addClass("photo").append(_img))
                .append($("<div/>").addClass("moji").html(msg["moji"]))
                .append($("<div/>").addClass("pin"))
                .click(function(){
                    $("#slide").show();
                })
            ;
            $("#bord").append(_cheki);
        }// end for
    };

    var gNowSlide=0;
   function make_slide(msgList){
       $("body").append($("<div/>").attr("id","slide"));

       //次の画像ボタン
       var nextButton=$("<div/>")
                .addClass("next")
                .click(function(){
                    jCarousel.slide(0,gNowSlide + 1,250);
                });
       //次の画像ボタン
       var prevButton=$("<div/>")
                .addClass("prev")
                .attr("id",PREV_BUTTON_ID)
                .click(function(){
                    jCarousel.slide(0,gNowSlide - 1,250);
                });
        //半透明な膜
       var maku = $("<div/>").addClass("maku").attr("id","maku");

       // $("#slide").append(maku);
       $("#slide").append(nextButton);
       $("#slide").append(prevButton);

       //カルーセル
       var jc = $("<ul/>").addClass("jCarousel");
       for(var i = 0 ; i < msgList.length; i = i + 1){
            var msg = msgList[i];
            var _img =
               $("<img/>")
               .attr("src",msg["large"])
               .hide()
               .load(function(){
                   $(this).css({"height":"100%","width":"100%"});
                    $(this).show();
               });

           var _large_cheki = $("<div />")
               .addClass("large_cheki")
               .attr("id","large_img"+ i)
               .attr("small_id","img"+i)
               .attr("no", i)
               .attr("next", i+1)
               .attr("prev", i-1)
               .css({"width":_img.naturalWidth(),"position":"relative","left":$(window).width()/2 - _img.naturalWidth()/2})
               .append($("<figure/>")
                       .addClass("large_photo")
                       .append(_img)
                       .css({"width":_img.naturalWidth(),"height":_img.naturalHeight()})
                       )
               .append(
                   $("<div/>")
                       .addClass("large_moji")
                       .html(msg["moji"])
               )
               .click(function(){
                    $("#slide").show();
                })
            ;


            jc.append(
                $("<li/>").append(_large_cheki)
            );
        }
       $("#slide").append(jc);

       jCarousel.ini();
       jCarousel.set();



   }

    // step2. 写真をダウンロードでき次第描画する
    //
    // 次の画像の位置を計算して、viewImageを呼び出す。
    // viewImageで画像の描画が終わったら、コールバックでこの関数を呼び出すので、
    // 画像がなくなるまでこの関数を繰り返すことになる。
    function viewNextImage(){
        if(gImgList.length != gImgUrlList.length){
            var no = gImgList.length;
            var url = gImgUrlList[no];
            var large_url = gLargeImgUrlList[no];
            //位置計算
            var top = TOP_MARGIN + Math.floor(no / MSG_ROW_NO ) * MSG_Y_SPAN;

            if(no % MSG_ROW_NO == 0){ //１列目
                var left = LEFT_MARGIN;
            }else{
                //何も考えずに格子状に配置する場合
                var left = LEFT_MARGIN + Math.floor(no % MSG_ROW_NO ) * MSG_X_SPAN;
                //左の写真の大きさを考慮する場合
                //leftside = gImgList[no - 1];
                //var left = leftside.offset().left + leftside.width();
            }
            var zIndex = gZIndexMax;
            viewImage(gImgList.length,url,large_url,top,left,zIndex,viewNextImage);
        }else{
            //描画完了
        }
    };

    //publicフィールド・関数定義
    wnw.list.display = display;
    wnw.list.addImage = addImage;
    wnw.list.assetPath = assetPath;
})();
