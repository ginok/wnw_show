// jQueryに naturalWidth() と naturalHeight()を追加する
(function($){
    var props = ['Width', 'Height'],prop;
    while (prop = props.pop()) {
       (function (natural, prop) {
           $.fn[natural] = (natural in new Image()) ?
               function () {return this[0][natural];} :
           function () {
               var node = this[0],img,value;
              if (node.tagName.toLowerCase() === 'img') {
                  img = new Image();
                img.src = node.src,value = img[prop];
              }
              return value;
          };
       }('natural' + prop, prop.toLowerCase()));
   }
}(jQuery));

var wnw;
if (!wnw) wnw = {};
if (!wnw.list) wnw.list = {};
(function(){
    function display(msgList){
        make_list(msgList);
        make_slide(msgList);
    };

    function add_msg(msg,i){
        var _img = $("<img/>")
            .attr("src",msg["small"])
            .hide()
            .load(function(){
                if($(this).naturalWidth() > $(this).naturalHeight()){
                    //横長であれば、写真のセンターが真ん中に来るようにずらす
                    var _left =  - ( $(this).naturalWidth() - $(this).naturalHeight() ) / 2;
                    $(this).css({"position":"absolute","height":"100%","left" : _left});
                }else{
                    //縦長であれば、ずらさない。写真の上を枠の上に重ねる配置。
                    var _top = 0;
                    $(this).css({"position":"absolute","width":"100%","top" : _top});
                }
                $(this).show();
            })
        ;
        //チェキ
        var _cheki = $("<div />")
            .addClass("cheki")
            .attr("id","img"+ i)
            .attr("large_id","large_img"+i)
            .attr("no", i)
            .attr("next", i+1)
            .attr("prev", i-1)
            .append($("<figure/>").addClass("photo").append(_img))
            .append($("<div/>").addClass("moji").html(msg["moji"]))
        //.append($("<div/>").addClass("pin")) // pinを追加する場合はここ
            .click(function(){
                $("#bord").hide();
                $("#slide").show();
                //n番目にスライドする関数をアニメーション時間0秒で実行して、
                //そのスライドを表示される
                jCarousel.slide($(this).attr("no"),0);
                //ここでリサイズしないと、liのwidthが100になってしまい表示がおかしくなる
                jCarousel.resize();
            })
        ;
        $("#bord_ul").prepend($("<li/>").addClass("cheki").append(_cheki));

    };

    function make_list(msgList){
        //背景
        $("body").append(
            $("<div/>")
                .attr("id","bord")
                .append($("<ul/>").attr("id","bord_ul"))
        );
        for(i = 0 ; i < msgList.length; i = i + 1){
            add_msg(msgList[i],i);
        }
    };

   function make_slide(msgList){
       $("body").append(
           $("<div/>")
               .attr("id","slide")
               .css({"opacity":0}) //hide()にするとうまく動かないので、一旦透明にする
       );

       //カルーセル
       var jc = $("<ul/>").addClass("jCarousel").attr("id","jCarousel");
       for(var i = 0 ; i < msgList.length; i = i + 1){
           var msg = msgList[i];
           var _large_img = $("<img/>")
               .attr("src",msg["large"])
               .attr("no",i)
               .hide()
               .load(function(){
                   $(this).css({"height":"100%","width":"100%"});
                   $(this).show();
                   console.log("loaded large_image: "+ $(this).attr("src") +  "  width=" +$(this).naturalWidth());
                   //画像のロードが完了したら親のdomのサイズを調整
                   $("#large_img" + $(this).attr("no")).css({
                       "position":"relative",
                       "width":$(this).naturalWidth(),
                       "left":$(window).width()/2 - $(this).naturalWidth()/2
                   });
                   $("#large_photo" + $(this).attr("no")).css({
                       "width":$(this).naturalWidth(),
                       "height":$(this).naturalHeight()
                   });
               });


           var _large_cheki = $("<div />")
               .addClass("large_cheki")
               .attr("id","large_img"+ i)
               .attr("small_id","img"+i)
               .attr("no", i)
               .attr("next", i+1)
               .attr("prev", i-1)
               .append($("<figure/>")
                       .addClass("large_photo")
                       .attr("id","large_photo" + i)
                       .append(_large_img)
                       )
               .append(
                   $("<div/>")
                       .addClass("large_moji")
                       .html(msg["moji"])
               )
            ;

            jc.append(
                $("<li/>").append(_large_cheki)
            );
        }
       $("#slide").append(jc);
       //カルーセルの初期化。先に<li>要素ができている必要があるため、このタイミング
       jCarousel.ini();
       jCarousel.set();
       //ここでhide()を指定して、その後透明を解除
       $("#slide").hide().css({"opacity":1});


       //次の画像ボタン
       var nextButton=$("<div/>")
           .addClass("next")
           .click(function(){
               _num=jCarousel.currentNum();
               jCarousel.slide((_num + 1 ) % jCarousel.maxNum(),250);
           });
       $("#slide").append(nextButton);

       //前の画像ボタン
       var prevButton=$("<div/>")
           .addClass("prev")
           .click(function(){
               _num=jCarousel.currentNum();
               jCarousel.slide((_num - 1 + jCarousel.maxNum() ) % jCarousel.maxNum(),250);
           });
       $("#slide").append(prevButton);

       //戻るボタン
       var backButton=$("<div/>")
           .addClass("back")
           .click(function(){
               $("#bord").show();
               $("#slide").hide();
           });
       $("#slide").append(backButton);


       //カウンタ
       var counter=$("<div/>")
           .addClass("counter");

        //半透明な膜
       //var maku = $("<div/>").addClass("maku").attr("id","maku");
       // $("#slide").append(maku);

   }

    //publicフィールド・関数定義
    wnw.list.display = display;
    wnw.list.add_msg = add_msg;
})();
