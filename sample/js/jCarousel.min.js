/*
 * jCarousel - jQuery Plugin
 * http://d.hatena.ne.jp/kudakurage/
 *
 * Copyright (c) 2010 Kazuyuki Motoyama
 * Licensed under the MIT license
 *
 * $Date: 2010-11-28
 * $version: 1.3
 *
 * This jQuery plugin will only run on devices running Mobile Safari
 * on iPhone or iPod Touch devices running iPhone OS 2.0 or later.
 * http://developer.apple.com/iphone/library/documentation/AppleApplications/Reference/SafariWebContent/HandlingEvents/HandlingEvents.html#//apple_ref/doc/uid/TP40006511-SW5
 */
var jCarousel={ua:"pc",
               num:0,
               target:0,
               sel:{width:0,max:0,left:0,current:0,startX:0,endX:0,auto:0},
               activeBool:false,
               active:0,
               main:0,
               colorSet:{
                   black:{
                       back:"#eee",
                       active:"#888",
                       shadow:"#333"
                   },
                   white:{
                       back:"#ddd",
                       active:"#999",
                       shadow:"#333"
                   }
               }
              };

jCarousel.set=function(){
    jCarousel.color=jCarousel.colorSet.black;
    jCarousel.main=0;

    jCarousel.target=$("#jCarousel");
    jCarousel.sel.width=jCarousel.target.width();
    var tHeight=jCarousel.target.height();
    jCarousel.sel.max=jCarousel.target.find("li").length;
    $(".jCarousel:after").css({
        visibility:"hidden",
        display:"block",
        clear:"both",
        height:0,
        fontSize:0,
        content:"."
    });
    $(".jCarousel").css({
        display:"inline-table",
        minHeight:"1%"
    });
    jCarousel.target.attr("id","jCarousel-object");
    jCarousel.target.wrap('<div class="jCarouselWrapper"></div>');
    $(".jCarouselWrapper")
        .append(
            $("<div>")
                .attr("id","jCarousel-counter")
                .css({"position":"fixed","left":"90%","top":"0%"}))
        .css({overflow:"hidden",width:"100%"});
    jCarousel.target.css({width:"900000px",listStyle:"none",padding:0,margin:0,backgroundColor:"transparent"});
    // liのcss
    $("#jCarousel-object > li")
        .css({"float":"left",width:jCarousel.sel.width+"px",listStyle:"none",padding:0,margin:0,color:"#000"});
    if(jCarousel.ua=="mobile"){
        jCarousel.target.bind("touchstart",function(){
            jCarousel.sel.startX=event.touches[0].pageX;
            jCarousel.sel.startY=event.touches[0].pageY;
            jCarousel.activeBool=true;
        });
        $(window).bind("touchmove",function(){
            if(jCarousel.activeBool){
                jCarousel.sel.endX=event.touches[0].pageX;
                jCarousel.sel.endY=event.touches[0].pageY;
                var offsetX=-jCarousel.sel.startX+jCarousel.sel.endX;
                var offsetY=-jCarousel.sel.startY+jCarousel.sel.endY;
                if(offsetX/offsetY>0.5||offsetX/offsetY<-0.5){
                    event.preventDefault();
                    jCarousel.target.css({marginLeft:jCarousel.sel.left+offsetX+"px"});
                }else jCarousel.activeBool=false;
            }
        });
        $(window).bind("touchend",function(){
            if(jCarousel.activeBool){
                jCarousel.activeBool=false;
                var offsetX=-jCarousel.sel.startX+jCarousel.sel.endX;
                var eventArea=jCarousel.sel.width/5;
                var carouselNum=jCarousel.sel.current;
                var carouselMax=jCarousel.sel.max;
                if(offsetX>eventArea&&carouselNum>0)carouselNum--;
                else if(offsetX<-eventArea&&carouselNum<carouselMax-1)carouselNum++;
                jCarousel.slide(carouselNum,200);
            }
        });
    }
    if(jCarousel.ua=="pc"){
        jCarousel.target.bind("mousedown",function(event){
            jCarousel.sel.startX=event.pageX;
            jCarousel.activeBool=true;
            return false;
        });
        $(window).bind("mousemove",function(event){
            if(jCarousel.activeBool){
                jCarousel.sel.endX=event.pageX;
                var offset=-jCarousel.sel.startX+jCarousel.sel.endX;

                jCarousel.target.css(
                    {marginLeft:jCarousel.sel.left+offset+"px"});
            }});
        $(window).bind("mouseup",function(event){
            if(jCarousel.activeBool){
                jCarousel.activeBool=false;
                jCarousel.sel.endX=event.pageX;
                var offset=-jCarousel.sel.startX+jCarousel.sel.endX;
                var eventArea=jCarousel.sel.width/5;
                var carouselNum=jCarousel.sel.current;
                var carouselMax=jCarousel.sel.max;
                if(offset>eventArea&&carouselNum>0)carouselNum--;
                else if(offset<-eventArea&&
                        carouselNum<carouselMax-1)carouselNum++;
                jCarousel.slide(carouselNum,250);
            }
        });
    }
    jCarousel.num++;
};

jCarousel.ini=function(){
    var ua=navigator.userAgent;
    if(ua.indexOf("iPhone")>-1||ua.indexOf("iPad")>-1||ua.indexOf("iPod")>-1||ua.indexOf("Android")>-1){
        jCarousel.ua="mobile";
    }else{
        jCarousel.ua="pc";
    }
    $(window).keydown(function(e){
        if(e.keyCode==39){
            var carouselNum=jCarousel.sel.current;
            var carouselMax=jCarousel.sel.max;
            if(carouselNum<carouselMax-1){
                carouselNum++;
                jCarousel.slide(carouselNum,800);
            }
        }
        if(e.keyCode==37){
            var carouselNum=jCarousel.sel.current;
            if(carouselNum>0){
                carouselNum--;
                jCarousel.slide(carouselNum,800);
            }
        }
    });
    $(window).bind("orientationchange",function(){
        jCarousel.resize();
    });
    $(window).resize(function(){
        jCarousel.resize();
    });
};

jCarousel.slide=function(carouselNum,speed){
    jCarousel.activeBool=false;
    var margin=-carouselNum*jCarousel.sel.width;
    jCarousel.target.animate({marginLeft:margin+"px"},speed,"easeCarousel",function(){});
    jCarousel.sel.left=margin;
    jCarousel.sel.current=carouselNum;
    $(".jCarouselWrapper .jCarouselNavi a").css({backgroundColor:jCarousel.color.back});
    $(".jCarouselWrapper .jCarouselNavi a[rel='"+carouselNum+"']").css({backgroundColor:jCarousel.color.active});
    $("#jCarousel-counter").html(carouselNum + "/" + jCarousel.maxNum());
};

jCarousel.currentNum=function(){
    return jCarousel.sel.current;
};
jCarousel.maxNum=function(){
    return jCarousel.sel.max;
};

jCarousel.resize=function(){
    $(".jCarousel").each(function(){
        var tWidth=$(".jCarouselWrapper").width();
        jCarousel.sel.width=tWidth;
        var margin=-jCarousel.sel.current*jCarousel.sel.width;
        jCarousel.sel.left=margin;
        $(this).find("li").css({width:tWidth+"px"});
        $(this).css({marginLeft:margin+"px"});
    });
};
jQuery.extend(
    jQuery.easing,{
        easeCarousel:function(x,t,b,c,d){
            return c*((t=t/d-1)*t*t+1)+b;
        }});

$(function(){
//    jCarousel.ini();
//    jCarousel.set();
});
